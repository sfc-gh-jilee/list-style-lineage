<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lineage List</title>
    <link rel="stylesheet" href="./styles.css" />
    <link rel="stylesheet" href="./lineage-graph.css" />
    <!-- React Flow CSS -->
    <link rel="stylesheet" href="https://unpkg.com/reactflow@11.11.4/dist/style.css" />
  </head>
  <body>
    <script>
      // Disable browser's automatic scroll restoration on reload
      if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        const HEADER_HEIGHT = 28;
        const CONTAINER_PADDING = 16;
        const PANEL_WIDTH = 280;
        const scrollContainer = document.querySelector('.lineage-scroll');
        const headers = Array.from(document.querySelectorAll('.depth-header'));
        
        // Store header data with order and natural positions
        const headerData = headers.map((header, index) => {
          return {
            el: header,
            order: index,
            naturalTop: 0 // Will be calculated after load
          };
        });

        function updateStickyHeaders() {
          if (!scrollContainer) return;
          
          const scrollTop = scrollContainer.scrollTop;
          const containerHeight = scrollContainer.clientHeight;
          const scrollBottom = scrollTop + containerHeight;
          
          // Calculate cumulative offsets for each header based on content above it
          let cumulativeOffset = 0;
          headerData.forEach((data, index) => {
            // Get the header's position relative to the scroll container's content
            const headerOffsetTop = data.el.offsetTop;
            
            // Calculate top sticky offset (how many headers above are stuck)
            const topOffset = index * HEADER_HEIGHT;
            
            // Calculate bottom sticky offset (how many headers below could be stuck)
            const bottomIndex = headerData.length - 1 - index;
            const bottomOffset = bottomIndex * HEADER_HEIGHT;
            
            // Apply sticky positioning with calculated offsets
            data.el.style.position = 'sticky';
            data.el.style.top = topOffset + 'px';
            data.el.style.bottom = bottomOffset + 'px';
            data.el.style.zIndex = 100 - index;
          });
        }

        // Function to recalculate natural positions
        function recalculateNaturalPositions() {
          if (!scrollContainer) return;
          headerData.forEach((data) => {
            data.naturalTop = getOffsetInContainer(data.el);
          });
        }

        // Run on scroll and resize
        scrollContainer.addEventListener('scroll', updateStickyHeaders, { passive: true });
        window.addEventListener('resize', () => {
          recalculateNaturalPositions();
          updateStickyHeaders();
        });
        
        // Initial calls - ensure layout is computed after images load
        updateStickyHeaders();
        requestAnimationFrame(updateStickyHeaders);
        
        // Helper to get element's top position relative to scroll container
        function getOffsetInContainer(element) {
          if (!scrollContainer) return 0;
          let offset = 0;
          let el = element;
          while (el && el !== scrollContainer && el !== document.body) {
            offset += el.offsetTop;
            el = el.offsetParent;
          }
          return offset;
        }

        // Also run after all resources (images) are loaded
        window.addEventListener('load', () => {
          // Calculate and store natural positions for all headers
          headerData.forEach((data) => {
            data.naturalTop = getOffsetInContainer(data.el);
          });
          
          // Scroll to center the focus section
          const focalHeader = document.querySelector('.depth-header--focal');
          const focalData = headerData.find(d => d.el === focalHeader);
          if (focalData && scrollContainer) {
            const containerHeight = scrollContainer.clientHeight;
            const targetScroll = focalData.naturalTop - (containerHeight / 2) + (HEADER_HEIGHT / 2);
            scrollContainer.scrollTo({ top: Math.max(0, targetScroll), behavior: 'instant' });
          }
          
          // Update sticky headers after scroll
          setTimeout(updateStickyHeaders, 10);
          setTimeout(updateStickyHeaders, 50);
          setTimeout(updateStickyHeaders, 100);
        });

        // Depth header click to scroll - scroll to show section at top
        headers.forEach((header, index) => {
          header.addEventListener('click', (e) => {
            if (!scrollContainer) return;
            
            // Use pre-calculated natural position
            const data = headerData[index];
            if (!data) return;
            
            // Scroll so this header is at the top, accounting for headers above
            const stickyOffset = index * HEADER_HEIGHT;
            const targetPosition = data.naturalTop - stickyOffset;
            scrollContainer.scrollTo({ top: Math.max(0, targetPosition), behavior: 'smooth' });
          });
        });

        // Group collapse toggle
        document.querySelectorAll('.group-header').forEach(groupHeader => {
          groupHeader.addEventListener('click', (e) => {
            e.stopPropagation();
            const group = groupHeader.closest('.object-group');
            group.classList.toggle('collapsed');
            // Update sticky headers after collapse animation
            setTimeout(updateStickyHeaders, 50);
            setTimeout(updateStickyHeaders, 150);
            setTimeout(updateStickyHeaders, 300);
          });
        });

        // Hover highlighting for connected objects
        const allItems = document.querySelectorAll('.group-list li');
        
        // Build a map of object names to their elements
        const objectMap = new Map();
        allItems.forEach(item => {
          const nameEl = item.querySelector('.object-name');
          if (nameEl) {
            const name = nameEl.textContent.trim().toLowerCase();
            if (!objectMap.has(name)) {
              objectMap.set(name, []);
            }
            objectMap.get(name).push(item);
          }
        });

        // Get depth level of an item
        function getDepthRow(item) {
          const depthContent = item.closest('.depth-content');
          return depthContent ? parseInt(depthContent.dataset.row) : null;
        }

        // Find connected objects with direction
        function getConnectedObjects(item) {
          const upstream = []; // -1 level (connection tags highlight)
          const downstream = []; // +1 level (object name highlights)
          const currentRow = getDepthRow(item);
          const currentName = item.querySelector('.object-name')?.textContent.trim().toLowerCase();
          
          // Get objects referenced in this item's connection tags
          const connectionTags = item.querySelectorAll('.connection-tag');
          connectionTags.forEach(tag => {
            const refName = tag.textContent.trim().toLowerCase();
            const refItems = objectMap.get(refName) || [];
            refItems.forEach(refItem => {
              const refRow = getDepthRow(refItem);
              if (refRow === currentRow - 1) {
                upstream.push(refItem);
              } else if (refRow === currentRow + 1) {
                downstream.push(refItem);
              }
            });
          });
          
          // Find objects that reference this item
          allItems.forEach(otherItem => {
            const otherRow = getDepthRow(otherItem);
            const otherTags = otherItem.querySelectorAll('.connection-tag');
            otherTags.forEach(tag => {
              if (tag.textContent.trim().toLowerCase() === currentName) {
                if (otherRow === currentRow - 1) {
                  upstream.push(otherItem);
                } else if (otherRow === currentRow + 1) {
                  downstream.push(otherItem);
                }
              }
            });
          });
          
          return { upstream, downstream };
        }

        // Add hover listeners
        allItems.forEach(item => {
          item.addEventListener('mouseenter', () => {
            // Highlight current row's connection tags
            item.classList.add('highlight-current');
            
            // Get connected objects
            const { upstream, downstream } = getConnectedObjects(item);
            
            // Highlight upstream (-1) objects - their connection tags
            upstream.forEach(upItem => {
              upItem.classList.add('highlight-upstream');
            });
            
            // Highlight downstream (+1) objects - their object names
            downstream.forEach(downItem => {
              downItem.classList.add('highlight-downstream');
            });
          });
          
          item.addEventListener('mouseleave', () => {
            item.classList.remove('highlight-current');
            document.querySelectorAll('.highlight-upstream').forEach(el => {
              el.classList.remove('highlight-upstream');
            });
            document.querySelectorAll('.highlight-downstream').forEach(el => {
              el.classList.remove('highlight-downstream');
            });
          });
        });

        // Click on connection-tag to scroll to and select corresponding node
        document.querySelectorAll('.connection-tag').forEach(tag => {
          tag.style.cursor = 'pointer';
          tag.addEventListener('click', (e) => {
            e.stopPropagation();
            const refName = tag.textContent.trim().toLowerCase();
            const refItems = objectMap.get(refName) || [];
            
            if (refItems.length > 0) {
              const targetItem = refItems[0];
              
              // Expand parent group if collapsed
              const parentGroup = targetItem.closest('.object-group');
              if (parentGroup && parentGroup.classList.contains('collapsed')) {
                parentGroup.classList.toggle('collapsed');
                setTimeout(() => {
                  scrollToItem(targetItem);
                  selectItem(targetItem);
                }, 100);
              } else {
                scrollToItem(targetItem);
                selectItem(targetItem);
              }
            }
          });
        });

        function scrollToItem(targetItem, highlight = true) {
          if (!scrollContainer || !targetItem) return;
          const targetTop = getOffsetInContainer(targetItem);
          const containerHeight = scrollContainer.clientHeight;
          const targetScroll = targetTop - (containerHeight / 2) + 16;
          
          scrollContainer.scrollTo({ top: Math.max(0, targetScroll), behavior: 'smooth' });
          
          // Briefly highlight the target (optional)
          if (highlight) {
            targetItem.style.transition = 'background 0.3s';
            targetItem.style.background = 'hsla(217, 13%, 94%, 1)';
            setTimeout(() => {
              targetItem.style.background = '';
              setTimeout(() => {
                targetItem.style.transition = '';
              }, 300);
            }, 1000);
          }
        }

        // Global function to center list view on focused/selected item
        window.centerListOnSelected = function() {
          // First try to find selected item
          const selectedItem = document.querySelector('.group-list li.selected');
          if (selectedItem) {
            scrollToItem(selectedItem, false);
            return;
          }
          
          // Fall back to focal item (in the focal depth section)
          const focalSection = document.querySelector('.depth-content--focal');
          if (focalSection) {
            const focalItem = focalSection.querySelector('.group-list li');
            if (focalItem) {
              scrollToItem(focalItem, false);
            }
          }
        };

        // Object selection and side panel
        const sidePanel = document.getElementById('sidePanel');
        const panelClose = document.getElementById('panelClose');
        const panelIcon = document.getElementById('panelIcon');
        const panelTitle = document.getElementById('panelTitle');
        const panelSchema = document.getElementById('panelSchema');
        let selectedListItem = null;

        // Global shared selection state (accessible by graph view)
        window.sharedSelection = {
          selectedItemId: null,
          selectedItemData: null,
          listeners: [],
          
          // Update selection from any view
          setSelection: function(itemId, itemData) {
            this.selectedItemId = itemId;
            this.selectedItemData = itemData;
            this.notifyListeners();
            this.updateSidePanel(itemData);
          },
          
          // Clear selection
          clearSelection: function() {
            this.selectedItemId = null;
            this.selectedItemData = null;
            this.notifyListeners();
            sidePanel.classList.add('hidden');
          },
          
          // Subscribe to selection changes
          addListener: function(callback) {
            this.listeners.push(callback);
          },
          
          // Notify all listeners of selection change
          notifyListeners: function() {
            this.listeners.forEach(cb => cb(this.selectedItemId, this.selectedItemData));
          },
          
          // Update side panel with item data
          updateSidePanel: function(itemData) {
            if (!itemData) return;
            panelTitle.textContent = itemData.name || 'Unknown';
            panelIcon.src = itemData.icon || './img/table.svg';
            panelSchema.textContent = itemData.schema || itemData.platform || '-';
            sidePanel.classList.remove('hidden');
          }
        };

        // Function to select an item in list view and sync globally
        function selectItem(item) {
          // Deselect previous in list
          if (selectedListItem) {
            selectedListItem.classList.remove('selected');
          }
          
          // Select new
          selectedListItem = item;
          item.classList.add('selected');
          
          // Get object info
          const objectName = item.querySelector('.object-name')?.textContent || 'Unknown';
          const objectIcon = item.querySelector('.object-icon')?.src || './img/table.svg';
          const groupName = item.closest('.object-group')?.querySelector('.group-name')?.textContent || '-';
          
          // Create item data and set global selection
          const itemId = objectName.toLowerCase().replace(/\s+/g, '_');
          window.sharedSelection.setSelection(itemId, {
            id: itemId,
            name: objectName,
            icon: objectIcon,
            schema: groupName
          });
        }

        // Listen for selection changes from graph view
        window.sharedSelection.addListener((itemId, itemData) => {
          // Update list view selection
          if (selectedListItem) {
            selectedListItem.classList.remove('selected');
            selectedListItem = null;
          }
          
          if (itemId && itemData) {
            // Find and highlight matching item in list view
            const matchName = itemData.name?.toUpperCase();
            allItems.forEach(item => {
              const nameEl = item.querySelector('.object-name');
              if (nameEl && nameEl.textContent.trim().toUpperCase() === matchName) {
                item.classList.add('selected');
                selectedListItem = item;
              }
            });
          }
        });

        // Click to select object in list view
        allItems.forEach(item => {
          item.style.cursor = 'pointer';
          item.addEventListener('click', (e) => {
            // Don't select if clicking on connection tag
            if (e.target.classList.contains('connection-tag')) return;
            
            selectItem(item);
          });
        });

        // Listen for selection changes from graph view to update list view
        window.sharedSelection.addListener((itemId, itemData) => {
          if (!itemId) {
            // Clear selection in list view
            if (selectedListItem) {
              selectedListItem.classList.remove('selected');
              selectedListItem = null;
            }
            return;
          }
          
          // Find and select the item in the list view
          const listItems = document.querySelectorAll('.group-list li');
          listItems.forEach(li => {
            const nameSpan = li.querySelector('.object-name');
            if (nameSpan && itemData && nameSpan.textContent.toLowerCase() === itemData.name?.toLowerCase()) {
              // Deselect previous
              if (selectedListItem) {
                selectedListItem.classList.remove('selected');
              }
              // Select new
              li.classList.add('selected');
              selectedListItem = li;
              
              // Scroll to the selected item if list view is visible
              const lineageScroll = document.querySelector('.lineage-scroll');
              if (lineageScroll && lineageScroll.style.display !== 'none') {
                scrollToItem(li, false);
              }
            }
          });
        });

        // Close panel
        panelClose.addEventListener('click', () => {
          window.sharedSelection.clearSelection();
          if (selectedListItem) {
            selectedListItem.classList.remove('selected');
            selectedListItem = null;
          }
          updateStickyHeaders();
        });

        // Segmented button toggle (Graph/List)
        const toggleBtns = document.querySelectorAll('.view-toggle .toggle-btn');
        const viewPanel = document.querySelector('.view-panel');
        const lineageScroll = document.querySelector('.lineage-scroll');
        const lineageGraph = document.querySelector('.lineage-graph');
        const toolBar = document.querySelector('.tool-bar');
        
        toggleBtns.forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Remove active from all
            toggleBtns.forEach(b => b.classList.remove('active'));
            // Add active to clicked
            btn.classList.add('active');
            
            // Toggle views based on button text
            const isGraphView = btn.textContent.trim() === 'Graph';
            
            if (isGraphView) {
              viewPanel.classList.add('graph-mode');
              lineageScroll.style.display = 'none';
              lineageGraph.style.display = 'block';
              
              // Center on selected node when switching to graph view
              setTimeout(() => {
                if (window.centerOnSelectedNode) {
                  window.centerOnSelectedNode();
                }
              }, 100);
            } else {
              viewPanel.classList.remove('graph-mode');
              lineageScroll.style.display = 'block';
              lineageGraph.style.display = 'none';
              
              // Center on selected/focal item when switching to list view
              setTimeout(() => {
                if (window.centerListOnSelected) {
                  window.centerListOnSelected();
                }
              }, 100);
            }
          });
        });
      });
    </script>

    <div class="main-layout">

      <div class="view-panel graph-mode">

        <div class="tool-bar">
          <div class="toolbar-left">
            <div class="view-toggle">
              <button class="toggle-btn active">Graph</button>
              <button class="toggle-btn">List</button>
            </div>
            <button class="toolbar-btn">
              <img src="./img/filter.svg" alt="" width="16" height="16">
              Filter
            </button>
          </div>
          <div class="toolbar-right">
            <button class="toolbar-btn icon-only">
              <img src="./img/maximize.svg" alt="" width="16" height="16">
            </button>
            <button class="toolbar-btn dropdown">
              <img src="./img/circle.svg" alt="" width="8" height="8">
              ORGADMIN
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 5l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="lineage-scroll" style="display: none;">
          <section class="lineage-table" aria-label="Lineage list">
            <!-- Upstream Level 3 (furthest) - Row 1 -->
            <div class="depth-header" data-row="1" data-order="0">
              <span class="depth-badge depth-badge--upstream">Upstream ‚àí3</span>
              
            </div>
            <div class="depth-content" data-row="1">
              <div class="object-group">
                <div class="group-header">
                  <img class="chevron" src="./img/chevron-down-small.svg" alt="">
                  <img class="group-icon" src="./img/api.svg" alt="API">
                  <span class="group-name">External APIs</span>
                  <span class="group-count">6</span>
                </div>
                <ul class="group-list">
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/api.svg" alt="API">
                      <span class="object-name">Shopify Orders API</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">orders</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/api.svg" alt="API">
                      <span class="object-name">Stripe Payments API</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">payments</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/api.svg" alt="API">
                      <span class="object-name">Salesforce CRM</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">customers</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/api.svg" alt="API">
                      <span class="object-name">Google Analytics 4</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">ga_sessions</span>
                      <span class="connection-tag">ga_events</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/api.svg" alt="API">
                      <span class="object-name">Facebook Ads API</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">ad_spend</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/api.svg" alt="API">
                      <span class="object-name">Mixpanel Events</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">product_events</span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
      
            <!-- Upstream Level 2 - Row 2 -->
            <div class="depth-header" data-row="2" data-order="1">
              <span class="depth-badge depth-badge--upstream">Upstream ‚àí2</span>
              
            </div>
            <div class="depth-content" data-row="2">
              <!-- Snowflake: RAW_ECOMMERCE -->
              <div class="object-group">
                <div class="group-header">
                  <img class="chevron" src="./img/chevron-down-small.svg" alt="">
                  <img class="group-icon" src="./img/logo-snowflake.svg" alt="Snowflake">
                  <span class="group-name">ACME_PROD / RAW_DB / RAW_ECOMMERCE</span>
                  <span class="group-count">3</span>
                </div>
                <ul class="group-list">
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/table.svg" alt="Table">
                      <span class="object-name">orders</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">stg_orders</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/table.svg" alt="Table">
                      <span class="object-name">payments</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">stg_payments</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/table.svg" alt="Table">
                      <span class="object-name">customers</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">stg_customers</span>
                      <span class="connection-tag">stg_orders</span>
                    </div>
                  </li>
                </ul>
              </div>
      
              <!-- Snowflake: RAW_MARKETING -->
              <div class="object-group">
                <div class="group-header">
                  <img class="chevron" src="./img/chevron-down-small.svg" alt="">
                  <img class="group-icon" src="./img/logo-snowflake.svg" alt="Snowflake">
                  <span class="group-name">ACME_PROD / RAW_DB / RAW_MARKETING</span>
                  <span class="group-count">4</span>
                </div>
                <ul class="group-list">
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/table.svg" alt="Table">
                      <span class="object-name">ga_sessions</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">stg_sessions</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/table.svg" alt="Table">
                      <span class="object-name">ga_events</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">stg_web_events</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/table.svg" alt="Table">
                      <span class="object-name">ad_spend</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">stg_ad_spend</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/table.svg" alt="Table">
                      <span class="object-name">product_events</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">stg_web_events</span>
                      <span class="connection-tag">stg_sessions</span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
      
            <!-- Upstream Level 1 - Row 3 -->
            <div class="depth-header" data-row="3" data-order="2">
              <span class="depth-badge depth-badge--upstream">Upstream ‚àí1</span>
              
            </div>
            <div class="depth-content" data-row="3">
              <div class="object-group">
                <div class="group-header">
                  <img class="chevron" src="./img/chevron-down-small.svg" alt="">
                  <img class="group-icon" src="./img/logo-snowflake.svg" alt="Snowflake">
                  <span class="group-name">ACME_PROD / TRANSFORM_DB / STAGING</span>
                  <span class="group-count">6</span>
                </div>
                <ul class="group-list">
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/view.svg" alt="View">
                      <span class="object-name">stg_orders</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--blue">orders</span>
                      <span class="connection-tag tag--blue">customers</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/view.svg" alt="View">
                      <span class="object-name">stg_payments</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--blue">payments</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/view.svg" alt="View">
                      <span class="object-name">stg_customers</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--blue">customers</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/view.svg" alt="View">
                      <span class="object-name">stg_sessions</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--green">ga_sessions</span>
                      <span class="connection-tag tag--green">product_events</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/view.svg" alt="View">
                      <span class="object-name">stg_web_events</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--green">ga_events</span>
                      <span class="connection-tag tag--green">product_events</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/view.svg" alt="View">
                      <span class="object-name">stg_ad_spend</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--green">ad_spend</span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
      
            <!-- Focal object - Row 4 -->
            <div class="depth-header depth-header--focal" data-row="4" data-order="3">
              <span class="depth-badge depth-badge--focal">Currently viewing</span>
              
            </div>
            <div class="depth-content depth-content--focal" data-row="4">
              <div class="object-group">
                <div class="group-header group-header--focal">
                  <img class="chevron" src="./img/chevron-down-small.svg" alt="">
                  <img class="group-icon" src="./img/logo-snowflake.svg" alt="Snowflake">
                  <span class="group-name">ACME_ANALYTICS / ANALYTICS_DB / ANALYTICS</span>
                  <span class="group-count">1</span>
                </div>
                <ul class="group-list">
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/dataset.svg" alt="Dataset">
                      <span class="object-name">fct_customer_orders</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--gray">stg_orders</span>
                      <span class="connection-tag tag--gray">stg_payments</span>
                      <span class="connection-tag tag--gray">stg_customers</span>
                      <span class="connection-tag tag--gray">stg_sessions</span>
                      <span class="connection-tag tag--gray">stg_web_events</span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
      
            <!-- Downstream Level 1 - Row 5 -->
            <div class="depth-header" data-row="5" data-order="4">
              <span class="depth-badge depth-badge--downstream">Downstream +1</span>
              
            </div>
            <div class="depth-content" data-row="5">
              <div class="object-group">
                <div class="group-header">
                  <img class="chevron" src="./img/chevron-down-small.svg" alt="">
                  <img class="group-icon" src="./img/logo-snowflake.svg" alt="Snowflake">
                  <span class="group-name">ACME_ANALYTICS / ANALYTICS_DB / MARTS</span>
                  <span class="group-count">4</span>
                </div>
                <ul class="group-list">
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/table.svg" alt="Table">
                      <span class="object-name">dim_customers</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">Customer 360</span>
                      <span class="connection-tag">churn_model</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/table.svg" alt="Table">
                      <span class="object-name">fct_daily_revenue</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">Exec Dashboard</span>
                      <span class="connection-tag">Finance Report</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/table.svg" alt="Table">
                      <span class="object-name">fct_attribution</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">Marketing ROI</span>
                      <span class="connection-tag">attribution_model</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/table.svg" alt="Table">
                      <span class="object-name">user_journey_agg</span>
                    </div>
                    <div class="connections connections--downstream">
                      <span class="connection-tag">Product Analytics</span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
      
            <!-- Downstream Level 2 - Row 6 -->
            <div class="depth-header" data-row="6" data-order="5">
              <span class="depth-badge depth-badge--downstream">Downstream +2</span>
              
            </div>
            <div class="depth-content" data-row="6">
              <!-- Tableau -->
              <div class="object-group">
                <div class="group-header">
                  <img class="chevron" src="./img/chevron-down-small.svg" alt="">
                  <img class="group-icon" src="./img/logo-tableau.svg" alt="Tableau">
                  <span class="group-name">Tableau</span>
                  <span class="group-count">1</span>
                </div>
                <ul class="group-list">
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/dashboard.svg" alt="Dashboard">
                      <span class="object-name">Exec Revenue Dashboard</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--purple">fct_daily_revenue</span>
                    </div>
                  </li>
                </ul>
              </div>
      
              <!-- Looker -->
              <div class="object-group">
                <div class="group-header">
                  <img class="chevron" src="./img/chevron-down-small.svg" alt="">
                  <img class="group-icon" src="./img/logo-looker.svg" alt="Looker">
                  <span class="group-name">Looker</span>
                  <span class="group-count">2</span>
                </div>
                <ul class="group-list">
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/dashboard.svg" alt="Dashboard">
                      <span class="object-name">Customer 360 Dashboard</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--purple">dim_customers</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/dashboard.svg" alt="Dashboard">
                      <span class="object-name">Marketing ROI Dashboard</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--purple">fct_attribution</span>
                    </div>
                  </li>
                </ul>
              </div>
      
              <!-- ML Models -->
              <div class="object-group">
                <div class="group-header">
                  <img class="chevron" src="./img/chevron-down-small.svg" alt="">
                  <img class="group-icon" src="./img/model.svg" alt="Model">
                  <span class="group-name">ML Models</span>
                  <span class="group-count">2</span>
                </div>
                <ul class="group-list">
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/model.svg" alt="Model">
                      <span class="object-name">churn_prediction_model</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--purple">dim_customers</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/model.svg" alt="Model">
                      <span class="object-name">attribution_model</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag tag--purple">fct_attribution</span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
      
            <!-- Downstream Level 3 - Row 7 -->
            <div class="depth-header" data-row="7" data-order="6">
              <span class="depth-badge depth-badge--downstream">Downstream +3</span>
              
            </div>
            <div class="depth-content" data-row="7">
              <div class="object-group">
                <div class="group-header">
                  <img class="chevron" src="./img/chevron-down-small.svg" alt="">
                  <img class="group-icon" src="./img/api.svg" alt="Export">
                  <span class="group-name">Exports</span>
                  <span class="group-count">2</span>
                </div>
                <ul class="group-list">
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/api.svg" alt="Email">
                      <span class="object-name">Finance Weekly Report</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag">Exec Dashboard</span>
                    </div>
                  </li>
                  <li>
                    <div class="object-info">
                      <img class="object-icon" src="./img/api.svg" alt="Export">
                      <span class="object-name">Investor Data Room</span>
                    </div>
                    <div class="connections connections--upstream">
                      <span class="connection-tag">Exec Dashboard</span>
                      <span class="connection-tag">Customer 360</span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </section>    
        </div>

        <div class="lineage-graph" id="lineage-graph-container" style="display: block;">
        </div>
      
      </div>

    <!-- Side Panel -->
    <aside class="side-panel hidden" id="sidePanel">
      <div class="panel-header">
        <img class="panel-header-icon" id="panelIcon" src="./img/table.svg" alt="">
        <span class="panel-header-title" id="panelTitle">Object Name</span>
        <span class="panel-close" id="panelClose">‚úï</span>
      </div>
      <div class="panel-content">
        <div class="panel-section">
          <div class="panel-label">Database / schema</div>
          <div class="panel-value" id="panelSchema">-</div>
        </div>
        <div class="panel-section">
          <div class="panel-label">Comment</div>
          <div class="panel-value" id="panelComment">-</div>
        </div>
        <div class="panel-section">
          <div class="panel-label">Owner</div>
          <div class="panel-value" id="panelOwner">ACCOUNTADMIN</div>
        </div>
        <div class="panel-section">
          <div class="panel-label">Created</div>
          <div class="panel-value" id="panelCreated">-</div>
        </div>
        <div class="panel-section">
          <div class="panel-label">Data quality</div>
          <div class="panel-value" id="panelQuality">-</div>
        </div>
        <div class="panel-section">
          <div class="panel-label">Rows</div>
          <div class="panel-value" id="panelRows">-</div>
        </div>
        <div class="panel-section">
          <div class="panel-label">Tags</div>
          <div class="panel-tags" id="panelTags">
            <span class="panel-tag">‚ü®‚ü© SEMANTIC_CATEGORY | EMAIL</span>
            <span class="panel-tag">üè¢ COST_CENTER | PRODUCT</span>
            <span class="panel-tag">üîí PII | DATA</span>
          </div>
        </div>
        <div class="panel-section">
          <div class="panel-columns-header">Columns</div>
          <div class="panel-search">
            <input type="text" placeholder="Search columns">
          </div>
          <div class="panel-column-list" id="panelColumns">
            <div class="panel-column-item"><span class="panel-column-icon">‚è±</span> PTIME</div>
            <div class="panel-column-item"><span class="panel-column-icon">‚ñ≥</span> TOPIC</div>
            <div class="panel-column-item"><span class="panel-column-icon">‚ñ≥</span> PRODUCT_KEY</div>
            <div class="panel-column-item"><span class="panel-column-icon">‚ñ≥</span> CITY</div>
          </div>
        </div>
      </div>
    </aside>
    </div>

    <!-- React Flow Graph View - UMD builds (dev for debugging) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/reactflow@11.11.4/dist/umd/index.js"></script>
    <script src="https://unpkg.com/elkjs@0.9.3/lib/elk.bundled.js"></script>

    <script>
      // Wait for DOM and libraries to load
      document.addEventListener('DOMContentLoaded', function() {
        // Extract from globals
        const { useState, useCallback, useEffect, useMemo, createElement } = React;
        const { createRoot } = ReactDOM;
        
        // Extract ReactFlow components - use named exports, not default
        const ReactFlowComponent = window.ReactFlow.ReactFlow;
        const Controls = window.ReactFlow.Controls;
        const Background = window.ReactFlow.Background;
        const useNodesState = window.ReactFlow.useNodesState;
        const useEdgesState = window.ReactFlow.useEdgesState;
        const Position = window.ReactFlow.Position;
        const Handle = window.ReactFlow.Handle;
        const ReactFlowProvider = window.ReactFlow.ReactFlowProvider;
        const useReactFlow = window.ReactFlow.useReactFlow;
        const BackgroundVariant = window.ReactFlow.BackgroundVariant;
        const MarkerType = window.ReactFlow.MarkerType;
        
        // Check if ReactFlow loaded
        if (!ReactFlowComponent) {
          console.error('ReactFlow not loaded. Available:', Object.keys(window.ReactFlow || {}));
          return;
        }
        
        const ELK = window.ELK;

      // =============================================
      // Mock Data - Hierarchical structure
      // Database > Schema > Objects
      // =============================================
      const mockLineageData = {
        depths: [
          {
            id: 'depth-1',
            level: -3,
            label: 'Upstream ‚àí3',
            type: 'upstream',
            groups: [
              {
                id: 'external-apis',
                name: 'External APIs',
                icon: './img/api.svg',
                type: 'platform', // No nested schema
                items: [
                  { id: 'shopify-api', name: 'Shopify Orders API', icon: './img/api.svg', downstream: ['orders'] },
                  { id: 'stripe-api', name: 'Stripe Payments API', icon: './img/api.svg', downstream: ['payments'] },
                  { id: 'salesforce-api', name: 'Salesforce CRM', icon: './img/api.svg', downstream: ['customers'] },
                  { id: 'ga4-api', name: 'Google Analytics 4', icon: './img/api.svg', downstream: ['ga_sessions', 'ga_events'] },
                  { id: 'fb-ads-api', name: 'Facebook Ads API', icon: './img/api.svg', downstream: ['ad_spend'] },
                  { id: 'mixpanel-api', name: 'Mixpanel Events', icon: './img/api.svg', downstream: ['product_events'] },
                ]
              }
            ]
          },
          {
            id: 'depth-2',
            level: -2,
            label: 'Upstream ‚àí2',
            type: 'upstream',
            groups: [
              {
                id: 'acme-raw-db',
                database: 'ACME_PROD',
                icon: './img/logo-snowflake.svg',
                type: 'database',
                schemas: [
                  {
                    id: 'raw-ecommerce',
                    name: 'RAW_ECOMMERCE',
                    items: [
                      { id: 'orders', name: 'ORDERS', icon: './img/table.svg', downstream: ['stg_orders'] },
                      { id: 'payments', name: 'PAYMENTS', icon: './img/table.svg', downstream: ['stg_payments'] },
                      { id: 'customers', name: 'CUSTOMERS', icon: './img/table.svg', downstream: ['stg_customers', 'stg_orders'] },
                    ]
                  },
                  {
                    id: 'raw-marketing',
                    name: 'RAW_MARKETING',
                    items: [
                      { id: 'ga_sessions', name: 'GA_SESSIONS', icon: './img/table.svg', downstream: ['stg_sessions'] },
                      { id: 'ga_events', name: 'GA_EVENTS', icon: './img/table.svg', downstream: ['stg_web_events'] },
                      { id: 'ad_spend', name: 'AD_SPEND', icon: './img/table.svg', downstream: ['stg_ad_spend'] },
                      { id: 'product_events', name: 'PRODUCT_EVENTS', icon: './img/table.svg', downstream: ['stg_web_events', 'stg_sessions'] },
                    ]
                  }
                ]
              }
            ]
          },
          {
            id: 'depth-3',
            level: -1,
            label: 'Upstream ‚àí1',
            type: 'upstream',
            groups: [
              {
                id: 'acme-transform-db',
                database: 'ACME_PROD',
                icon: './img/logo-snowflake.svg',
                type: 'database',
                schemas: [
                  {
                    id: 'staging',
                    name: 'STAGING',
                    items: [
                      { id: 'stg_orders', name: 'STG_ORDERS', icon: './img/view.svg', downstream: ['fct_customer_orders'] },
                      { id: 'stg_payments', name: 'STG_PAYMENTS', icon: './img/view.svg', downstream: ['fct_customer_orders'] },
                      { id: 'stg_customers', name: 'STG_CUSTOMERS', icon: './img/view.svg', downstream: ['fct_customer_orders'] },
                      { id: 'stg_sessions', name: 'STG_SESSIONS', icon: './img/view.svg', downstream: ['fct_customer_orders'] },
                      { id: 'stg_web_events', name: 'STG_WEB_EVENTS', icon: './img/view.svg', downstream: ['fct_customer_orders'] },
                      { id: 'stg_ad_spend', name: 'STG_AD_SPEND', icon: './img/view.svg', downstream: [] },
                    ]
                  }
                ]
              }
            ]
          },
          {
            id: 'depth-4',
            level: 0,
            label: 'Currently viewing',
            type: 'focal',
            groups: [
              {
                id: 'acme-analytics-db',
                database: 'ANALYTICS_DB',
                icon: './img/logo-snowflake.svg',
                type: 'database',
                schemas: [
                  {
                    id: 'analytics',
                    name: 'ANALYTICS',
                    items: [
                      { id: 'fct_customer_orders', name: 'FCT_CUSTOMER_ORDERS', icon: './img/dataset.svg', downstream: ['dim_customers', 'fct_daily_revenue', 'fct_attribution', 'user_journey_agg'], isFocal: true },
                    ]
                  }
                ]
              }
            ]
          },
          {
            id: 'depth-5',
            level: 1,
            label: 'Downstream +1',
            type: 'downstream',
            groups: [
              {
                id: 'acme-marts-db',
                database: 'ACME_ANALYTICS',
                icon: './img/logo-snowflake.svg',
                type: 'database',
                schemas: [
                  {
                    id: 'marts',
                    name: 'MARTS',
                    items: [
                      { id: 'dim_customers', name: 'DIM_CUSTOMERS', icon: './img/table.svg', downstream: ['customer-360-dashboard', 'churn_prediction_model'] },
                      { id: 'fct_daily_revenue', name: 'FCT_DAILY_REVENUE', icon: './img/table.svg', downstream: ['exec-revenue-dashboard'] },
                      { id: 'fct_attribution', name: 'FCT_ATTRIBUTION', icon: './img/table.svg', downstream: ['marketing-roi-dashboard', 'attribution_model'] },
                      { id: 'user_journey_agg', name: 'USER_JOURNEY_AGG', icon: './img/table.svg', downstream: [] },
                    ]
                  }
                ]
              }
            ]
          },
          {
            id: 'depth-6',
            level: 2,
            label: 'Downstream +2',
            type: 'downstream',
            groups: [
              {
                id: 'tableau',
                name: 'Tableau',
                icon: './img/logo-tableau.svg',
                type: 'platform',
                items: [
                  { id: 'exec-revenue-dashboard', name: 'Exec Revenue Dashboard', icon: './img/dashboard.svg', downstream: ['finance-weekly-report'] },
                ]
              },
              {
                id: 'looker',
                name: 'Looker',
                icon: './img/logo-looker.svg',
                type: 'platform',
                items: [
                  { id: 'customer-360-dashboard', name: 'Customer 360 Dashboard', icon: './img/dashboard.svg', downstream: ['investor-data-room'] },
                  { id: 'marketing-roi-dashboard', name: 'Marketing ROI Dashboard', icon: './img/dashboard.svg', downstream: [] },
                ]
              },
              {
                id: 'ml-models',
                name: 'ML Models',
                icon: './img/model.svg',
                type: 'platform',
                items: [
                  { id: 'churn_prediction_model', name: 'Churn Prediction Model', icon: './img/model.svg', downstream: [] },
                  { id: 'attribution_model', name: 'Attribution Model', icon: './img/model.svg', downstream: [] },
                ]
              }
            ]
          },
          {
            id: 'depth-7',
            level: 3,
            label: 'Downstream +3',
            type: 'downstream',
            groups: [
              {
                id: 'exports',
                name: 'Exports',
                icon: './img/api.svg',
                type: 'platform',
                items: [
                  { id: 'finance-weekly-report', name: 'Finance Weekly Report', icon: './img/api.svg', downstream: [] },
                  { id: 'investor-data-room', name: 'Investor Data Room', icon: './img/api.svg', downstream: [] },
                ]
              }
            ]
          }
        ]
      };

      // =============================================
      // Custom Node: Object Card (single table/view)
      // =============================================
      function ObjectCardNode({ data, selected, id }) {
        const { item, onItemClick, selectedItemId, isFocal } = data;
        const isSelected = selected || selectedItemId === item.id;

        return React.createElement('div', { 
          className: `graph-object-card ${isSelected ? 'selected' : ''} ${isFocal ? 'focal' : ''}`,
          onClick: () => onItemClick?.(item, id)
        },
          React.createElement(Handle, {
            type: 'target',
            position: Position.Left,
            id: 'left'
          }),
          // Focal badge
          isFocal && React.createElement('div', { className: 'graph-object-focal-badge' }, 'Currently viewing'),
          // Object info
          React.createElement('div', { className: 'graph-object-info' },
            React.createElement('img', { className: 'graph-object-icon', src: item.icon, alt: '' }),
            React.createElement('span', { className: 'graph-object-name' }, item.name)
          ),
          React.createElement(Handle, {
            type: 'source',
            position: Position.Right,
            id: 'right'
          })
        );
      }

      // =============================================
      // Custom Node: Group Node (database > schema > items)
      // =============================================
      function GroupNode({ data, id }) {
        const { database, schema, icon, items, onItemClick, selectedItemId } = data;
        const isSingleItem = items.length === 1;

        return React.createElement('div', { className: 'graph-group-container' },
          // Database header
          React.createElement('div', { className: 'graph-group-db-header' },
            React.createElement('img', { className: 'graph-group-db-icon', src: icon, alt: '' }),
            React.createElement('img', { className: 'graph-group-db-icon', src: './img/database.svg', alt: '' }),
            React.createElement('span', { className: 'graph-group-db-name' }, database)
          ),
          // Schema section
          React.createElement('div', { className: 'graph-group-schema-section' },
            React.createElement('div', { className: 'graph-group-schema-header' },
              React.createElement('img', { className: 'graph-group-schema-icon', src: './img/schema.svg', alt: '' }),
              React.createElement('span', { className: 'graph-group-schema-name' }, schema)
            ),
            // Items - regular card for single item, compact list for multiple
            React.createElement('div', { className: 'graph-group-items' },
              items.map((item, index) => 
                isSingleItem 
                  // Single item - render as regular card
                  ? React.createElement('div', {
                      key: item.id,
                      className: `graph-group-card ${selectedItemId === item.id ? 'selected' : ''} ${item.isFocal ? 'focal' : ''}`,
                      onClick: (e) => {
                        e.stopPropagation();
                        onItemClick?.(item, id);
                      }
                    },
                      React.createElement(Handle, {
                        type: 'target',
                        position: Position.Left,
                        id: `left-${item.id}`,
                        style: { top: '50%', transform: 'translateY(-50%)' }
                      }),
                      item.isFocal && React.createElement('div', { className: 'graph-group-card-badge' }, 'Currently viewing'),
                      React.createElement('div', { className: 'graph-group-card-content' },
                        React.createElement('img', { className: 'graph-group-card-icon', src: item.icon, alt: '' }),
                        React.createElement('span', { className: 'graph-group-card-name' }, item.name)
                      ),
                      React.createElement(Handle, {
                        type: 'source',
                        position: Position.Right,
                        id: `right-${item.id}`,
                        style: { top: '50%', transform: 'translateY(-50%)' }
                      })
                    )
                  // Multiple items - render as compact list item
                  : React.createElement('div', {
                      key: item.id,
                      className: `graph-group-item ${selectedItemId === item.id ? 'selected' : ''} ${item.isFocal ? 'focal' : ''}`,
                      onClick: (e) => {
                        e.stopPropagation();
                        onItemClick?.(item, id);
                      }
                    },
                      React.createElement(Handle, {
                        type: 'target',
                        position: Position.Left,
                        id: `left-${item.id}`,
                        style: { top: 'auto', bottom: 'auto' }
                      }),
                      React.createElement('img', { className: 'graph-group-item-icon', src: item.icon, alt: '' }),
                      React.createElement('span', { className: 'graph-group-item-name' }, item.name),
                      React.createElement(Handle, {
                        type: 'source',
                        position: Position.Right,
                        id: `right-${item.id}`,
                        style: { top: 'auto', bottom: 'auto' }
                      })
                    )
              )
            )
          )
        );
      }

      // =============================================
      // Custom Node: Platform Group (Tableau, Looker, etc)
      // =============================================
      function PlatformGroupNode({ data, id }) {
        const { name, icon, items, platformId, onItemClick, selectedItemId } = data;

        return React.createElement('div', { className: `graph-platform-container platform-${platformId}` },
          // Platform header
          React.createElement('div', { className: 'graph-platform-header' },
            React.createElement('img', { className: 'graph-platform-icon', src: icon, alt: '' }),
            React.createElement('span', { className: 'graph-platform-name' }, name),
            React.createElement('span', { className: 'graph-platform-count' }, items.length)
          ),
          // Items list
          React.createElement('div', { className: 'graph-platform-items' },
            items.map((item, index) => 
              React.createElement('div', {
                key: item.id,
                className: `graph-platform-item ${selectedItemId === item.id ? 'selected' : ''}`,
                onClick: (e) => {
                  e.stopPropagation();
                  onItemClick?.(item, id);
                }
              },
                React.createElement(Handle, {
                  type: 'target',
                  position: Position.Left,
                  id: `left-${item.id}`,
                  style: { top: 'auto', bottom: 'auto' }
                }),
                React.createElement('img', { className: 'graph-platform-item-icon', src: item.icon, alt: '' }),
                React.createElement('span', { className: 'graph-platform-item-name' }, item.name),
                React.createElement(Handle, {
                  type: 'source',
                  position: Position.Right,
                  id: `right-${item.id}`,
                  style: { top: 'auto', bottom: 'auto' }
                })
              )
            )
          )
        );
      }

      // =============================================
      // Node Types Registry
      // =============================================
      const nodeTypes = {
        objectCard: ObjectCardNode,
        groupNode: GroupNode,
        platformGroup: PlatformGroupNode,
      };

      // =============================================
      // ELK Layout Configuration
      // =============================================
      const elk = new ELK();

      const elkLayoutOptions = {
        'elk.algorithm': 'layered',
        'elk.direction': 'RIGHT',
        'elk.spacing.nodeNode': '72',
        'elk.layered.spacing.nodeNodeBetweenLayers': '120',
        'elk.layered.spacing.edgeNodeBetweenLayers': '40',
        'elk.edgeRouting': 'SPLINES',
        'elk.layered.nodePlacement.strategy': 'BRANDES_KOEPF',
        'elk.layered.nodePlacement.bk.fixedAlignment': 'BALANCED',
        'elk.layered.crossingMinimization.strategy': 'LAYER_SWEEP',
        'elk.contentAlignment': 'V_CENTER',
        'elk.nodeLabels.placement': 'INSIDE V_CENTER H_CENTER',
      };

      async function calculateLayout(nodes, edges) {
        const elkGraph = {
          id: 'root',
          layoutOptions: elkLayoutOptions,
          children: nodes.map(node => ({
            id: node.id,
            width: node.data.width || 240,
            height: node.data.height || 100,
            // Assign layer based on depth
            layoutOptions: {
              'elk.layered.layerConstraint': node.data.layer !== undefined ? node.data.layer.toString() : undefined,
            }
          })),
          edges: edges.map(edge => ({
            id: edge.id,
            sources: [edge.source],
            targets: [edge.target],
          })),
        };

        const layoutedGraph = await elk.layout(elkGraph);

        // First pass: get positions from ELK
        const layoutedNodes = nodes.map(node => {
          const layoutedNode = layoutedGraph.children.find(n => n.id === node.id);
          return {
            ...node,
            position: {
              x: layoutedNode?.x || 0,
              y: layoutedNode?.y || 0,
            },
          };
        });

        // Second pass: center each column vertically
        // Group nodes by layer
        const nodesByLayer = {};
        layoutedNodes.forEach(node => {
          const layer = node.data.layer;
          if (layer !== undefined) {
            if (!nodesByLayer[layer]) {
              nodesByLayer[layer] = [];
            }
            nodesByLayer[layer].push(node);
          }
        });

        // Find global min and max Y across all nodes to determine canvas height
        let globalMinY = Infinity;
        let globalMaxY = -Infinity;
        layoutedNodes.forEach(node => {
          const nodeHeight = node.data.height || 100;
          globalMinY = Math.min(globalMinY, node.position.y);
          globalMaxY = Math.max(globalMaxY, node.position.y + nodeHeight);
        });
        const canvasHeight = globalMaxY - globalMinY;
        const canvasCenterY = globalMinY + canvasHeight / 2;

        // Center each layer's nodes vertically
        Object.keys(nodesByLayer).forEach(layer => {
          const layerNodes = nodesByLayer[layer];
          
          // Find layer's vertical extent
          let layerMinY = Infinity;
          let layerMaxY = -Infinity;
          layerNodes.forEach(node => {
            const nodeHeight = node.data.height || 100;
            layerMinY = Math.min(layerMinY, node.position.y);
            layerMaxY = Math.max(layerMaxY, node.position.y + nodeHeight);
          });
          
          const layerHeight = layerMaxY - layerMinY;
          const layerCenterY = layerMinY + layerHeight / 2;
          const offsetY = canvasCenterY - layerCenterY;
          
          // Apply offset to center the layer
          layerNodes.forEach(node => {
            node.position.y += offsetY;
          });
        });

        return layoutedNodes;
      }

      // =============================================
      // Transform Mock Data to Nodes & Edges
      // Groups with compact cards, focal as single card
      // =============================================
      function transformDataToNodesAndEdges(data, onItemClick, selectedItemId) {
        const nodes = [];
        const edges = [];
        const allItems = [];
        const itemToHandleMap = new Map(); // Map item id to node id and handle id

        data.depths.forEach((depth, depthIndex) => {
          depth.groups.forEach((group, groupIndex) => {
            
            if (group.type === 'database' && group.schemas) {
              // Database group with schemas - create group nodes
              group.schemas.forEach((schema, schemaIndex) => {
                const groupNodeId = `group-${group.id}-${schema.id}`;
                const itemHeight = 40;
                const headerHeight = 70;
                const nodeHeight = headerHeight + (schema.items.length * itemHeight) + 24;
                
                // Check if this group contains the focal item
                const hasFocal = schema.items.some(item => item.isFocal);
                
                // Always use groupNode for database/schema structures
                nodes.push({
                  id: groupNodeId,
                  type: 'groupNode',
                  position: { x: 0, y: 0 },
                  data: {
                    database: group.database,
                    schema: schema.name,
                    icon: group.icon,
                    items: schema.items,
                    onItemClick,
                    selectedItemId,
                    hasFocal,
                    layer: depthIndex,
                    width: 340,
                    height: nodeHeight,
                  },
                });
                  
                // Map each item to handles on this group node
                schema.items.forEach(item => {
                  itemToHandleMap.set(item.id, { 
                    nodeId: groupNodeId, 
                    sourceHandle: `right-${item.id}`,
                    targetHandle: `left-${item.id}`
                  });
                  allItems.push({ ...item, nodeId: groupNodeId, isFocal: item.isFocal });
                });
              });
              
            } else if (group.type === 'platform' && group.items) {
              // Platform group (Tableau, Looker, etc)
              const platformNodeId = `platform-${group.id}`;
              const itemHeight = 40;
              const headerHeight = 40;
              const nodeHeight = headerHeight + (group.items.length * itemHeight) + 16;
              
              nodes.push({
                id: platformNodeId,
                type: 'platformGroup',
                position: { x: 0, y: 0 },
                data: {
                  name: group.name,
                  icon: group.icon,
                  items: group.items,
                  platformId: group.id,
                  onItemClick,
                  selectedItemId,
                  layer: depthIndex,
                  width: 340,
                  height: nodeHeight,
                },
              });
              
              // Map each item to handles on this platform node
              group.items.forEach(item => {
                itemToHandleMap.set(item.id, { 
                  nodeId: platformNodeId, 
                  sourceHandle: `right-${item.id}`,
                  targetHandle: `left-${item.id}`
                });
                allItems.push({ ...item, nodeId: platformNodeId });
              });
            }
          });
        });

        // Create edges between items using handle mapping
        allItems.forEach(item => {
          if (item.downstream && item.downstream.length > 0) {
            item.downstream.forEach(targetItemId => {
              const sourceMapping = itemToHandleMap.get(item.id);
              const targetMapping = itemToHandleMap.get(targetItemId);
              
              if (sourceMapping && targetMapping) {
                edges.push({
                  id: `edge-${item.id}-${targetItemId}`,
                  source: sourceMapping.nodeId,
                  sourceHandle: sourceMapping.sourceHandle,
                  target: targetMapping.nodeId,
                  targetHandle: targetMapping.targetHandle,
                  type: 'default',
                  animated: false,
                  markerEnd: {
                    type: MarkerType.ArrowClosed,
                    width: 12,
                    height: 12,
                    color: '#BDC4D5',
                  },
                });
              }
            });
          }
        });

        return { nodes, edges, allItems };
      }

      // =============================================
      // Main Graph Component
      // =============================================
      function LineageGraph() {
        const [nodes, setNodes, onNodesChange] = useNodesState([]);
        const [edges, setEdges, onEdgesChange] = useEdgesState([]);
        const [selectedItem, setSelectedItem] = useState(null);
        const [isLoading, setIsLoading] = useState(true);
        const reactFlowInstance = useReactFlow();

        // Handle item click - update shared selection and center view
        const handleItemClick = useCallback((item, nodeId) => {
          setSelectedItem(item);
          
          // Sync with global shared selection
          if (window.sharedSelection) {
            window.sharedSelection.setSelection(item.id, {
              id: item.id,
              name: item.name,
              icon: item.icon,
              schema: item.schema || item.platform || '-'
            });
          }
          
          // Center view on the selected node
          if (reactFlowInstance && nodeId) {
            const node = reactFlowInstance.getNode(nodeId);
            if (node) {
              const x = node.position.x + (node.width || 304) / 2;
              const y = node.position.y + (node.height || 40) / 2;
              reactFlowInstance.setCenter(x, y, { zoom: 1, duration: 300 });
            }
          }
        }, [reactFlowInstance]);

        // Center on focal node when ReactFlow initializes
        const onInit = useCallback((instance) => {
          console.log('ReactFlow onInit called');
          setTimeout(() => {
            const allNodes = instance.getNodes();
            const focalNode = allNodes.find(n => 
              n.data.isFocal || 
              n.data.hasFocal || 
              n.data.items?.some(item => item.isFocal)
            );
            
            console.log('onInit - focalNode:', focalNode);
            
            if (focalNode) {
              const x = focalNode.position.x + (focalNode.data.width || 304) / 2;
              const y = focalNode.position.y + (focalNode.data.height || 100) / 2;
              console.log('onInit - centering to:', { x, y });
              instance.setCenter(x, y, { zoom: 0.9, duration: 0 });
            }
          }, 100);
        }, []);
        
        // Listen for selection changes from list view
        useEffect(() => {
          if (window.sharedSelection) {
            const handleSelectionChange = (itemId, itemData) => {
              if (itemId) {
                setSelectedItem({ id: itemId, ...itemData });
                
                // Center view on the selected node
                if (reactFlowInstance) {
                  // Find the node containing this item
                  const allNodes = reactFlowInstance.getNodes();
                  const targetNode = allNodes.find(node => {
                    // Check if this node contains the item
                    if (node.data.item?.id === itemId) return true;
                    if (node.data.items?.some(item => item.id === itemId)) return true;
                    return false;
                  });
                  
                  if (targetNode) {
                    const x = targetNode.position.x + (targetNode.width || targetNode.data.width || 304) / 2;
                    const y = targetNode.position.y + (targetNode.height || targetNode.data.height || 100) / 2;
                    reactFlowInstance.setCenter(x, y, { zoom: 1, duration: 300 });
                  }
                }
              } else {
                setSelectedItem(null);
              }
            };
            
            window.sharedSelection.addListener(handleSelectionChange);
            
            // Initialize with current selection if any
            if (window.sharedSelection.selectedItemId) {
              setSelectedItem({
                id: window.sharedSelection.selectedItemId,
                ...window.sharedSelection.selectedItemData
              });
            }
          }
        }, [reactFlowInstance]);

        // Initialize layout
        useEffect(() => {
          async function initLayout() {
            setIsLoading(true);
            const { nodes: initialNodes, edges: initialEdges, allItems } = transformDataToNodesAndEdges(
              mockLineageData, 
              handleItemClick,
              selectedItem?.id
            );
            
            try {
              const layoutedNodes = await calculateLayout(initialNodes, initialEdges);
              setNodes(layoutedNodes);
              setEdges(initialEdges);
              
            } catch (error) {
              console.error('Layout error:', error);
              setNodes(initialNodes);
              setEdges(initialEdges);
            }
            setIsLoading(false);
          }
          
          initLayout();
        }, []);

        // Update nodes when selection changes
        useEffect(() => {
          const currentSelectedId = selectedItem?.id || window.sharedSelection?.selectedItemId;
          setNodes(nds => nds.map(node => ({
            ...node,
            data: {
              ...node.data,
              selectedItemId: currentSelectedId,
            },
          })));
        }, [selectedItem, setNodes]);

        // Expose global function to center on selected/focal node
        useEffect(() => {
          window.centerOnSelectedNode = () => {
            if (!reactFlowInstance) return;
            
            const allNodes = reactFlowInstance.getNodes();
            const currentSelectedId = selectedItem?.id || window.sharedSelection?.selectedItemId;
            
            let targetNode = null;
            
            // First try to find the selected node
            if (currentSelectedId) {
              targetNode = allNodes.find(node => {
                if (node.data.item?.id === currentSelectedId) return true;
                if (node.data.items?.some(item => item.id === currentSelectedId)) return true;
                return false;
              });
            }
            
            // Fall back to focal node if no selection
            if (!targetNode) {
              targetNode = allNodes.find(node => 
                node.data.isFocal || node.data.hasFocal || node.data.items?.some(item => item.isFocal)
              );
            }
            
            if (targetNode) {
              const x = targetNode.position.x + (targetNode.width || targetNode.data.width || 304) / 2;
              const y = targetNode.position.y + (targetNode.height || targetNode.data.height || 100) / 2;
              reactFlowInstance.setCenter(x, y, { zoom: 1, duration: 300 });
            }
          };
          
          return () => {
            delete window.centerOnSelectedNode;
          };
        }, [reactFlowInstance, selectedItem]);

        if (isLoading) {
          return React.createElement('div', { className: 'graph-loading' },
            React.createElement('div', { className: 'graph-loading-spinner' }),
            'Loading graph...'
          );
        }

        return React.createElement(ReactFlowComponent, {
          nodes,
          edges,
          onNodesChange,
          onEdgesChange,
          onInit,
          nodeTypes,
          defaultViewport: { x: 0, y: 0, zoom: 0.9 },
          minZoom: 0.1,
          maxZoom: 2,
          defaultEdgeOptions: {
            type: 'default',  // bezier curves
          },
          proOptions: { hideAttribution: true },
        },
          React.createElement(Background, {
            variant: BackgroundVariant.Dots,
            gap: 20,
            size: 1.5,
            color: 'rgba(213, 218, 228, 1)'
          }),
          React.createElement(Controls, { 
            showInteractive: false,
            position: 'bottom-left'
          })
        );
      }

      // =============================================
      // Mount React App with Provider
      // =============================================
      const container = document.getElementById('lineage-graph-container');
      if (container) {
        const root = createRoot(container);
        root.render(
          React.createElement(ReactFlowProvider, null,
            React.createElement(LineageGraph)
          )
        );
      }
      
      }); // End DOMContentLoaded
    </script>
  </body>
</html>
